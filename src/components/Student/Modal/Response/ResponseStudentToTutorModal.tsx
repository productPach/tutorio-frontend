"use client";

import { useAppDispatch, useAppSelector } from "@/store/store";
import clsx from "clsx";
import styles from "../../../Tutor/Modal/Profil/ProfileInfo/ProfileInfo.module.css";
import stylesStudent from "../../Student.module.css";
import generalStyles from "../../../../app/student/layout.module.css";
import { ChangeEvent, useState } from "react";
import {
  setIsModalResponseStudentToTutor,
  setIsSheetOpen,
  setLoadingPage,
  setScrollY,
} from "@/store/features/modalSlice";
import {
  createChat,
  getChatsByOrderId,
  getChatsByUserId,
  sendMessage,
  setChat,
} from "@/store/features/chatSlice";
import { useChat } from "@/context/ChatContext";
import { useRouter } from "next/navigation";
import { data } from "@/utils/listSubjects";
import { Spinner } from "@/components/Spinner/Spinner";
import { getOrderById } from "@/store/features/orderSlice";

export const ResponseStudentToTutorModal = () => {
  const dispatch = useAppDispatch();
  const route = useRouter();
  // –ü–æ–ª—É—á–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ tutor –∏–∑ Redux
  const token = useAppSelector((state) => state.auth.token);
  const { newChat } = useChat();
  const student = useAppSelector((state) => state.student.student);
  const tutorId = useAppSelector(
    (state) => state.modal.tutorIdForResponseStudentToTutor
  );
  const { orderById } = useAppSelector((state) => state.orders);
  // –°—Ç–µ–π—Ç –¥–ª—è –∑–Ω–∞–µ–Ω–∏—è –∏–Ω–ø—É—Ç–∞ —Å —Å—É–º–º–æ–π –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è
  const [inputValue, setInputValue] = useState("");
  const handleInputValue = (e: ChangeEvent<HTMLTextAreaElement>) => {
    const value = e.target.value; // –£–±–∏—Ä–∞–µ–º –≤—Å–µ –Ω–µ –±—É–∫–≤–µ–Ω–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã
    setInputValue(value);
  };
  // –°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –æ—à–∏–±–∫–∏ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—è
  const [errorInput, setErrorInput] = useState(false);

  // –°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è —Ñ–∏–∫—Å–∞—Ü–∏–∏ —Ñ–æ–∫—É—Å–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞ –ø–æ–ª–µ —Å –≤–≤–æ–¥–æ–º —Ç–µ–ª–µ—Ñ–æ–Ω–∞
  const [isFocused, setIsFocused] = useState(false);
  const handleFocus = () => setIsFocused(true);
  const handleBlur = () => setIsFocused(false);

  // –°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –ª–æ–∞–¥–µ—Ä–∞
  const [isLoading, setIsLoading] = useState(false);

  const subjectForRequest = data.find(
    (item) => item.id_p === orderById?.subject
  )?.for_request;

  const update = async () => {
    setIsLoading(true);
    const messageResponse = inputValue;

    if (tutorId && student && orderById && token && messageResponse) {
      try {
        const themeOrder = `${orderById.goal} –ø–æ ${subjectForRequest}`;
        const chat = await dispatch(
          createChat({
            tutorId: tutorId,
            studentId: student.id,
            orderId: orderById.id,
            initiatorRole: "student",
            themeOrder: themeOrder,
            status: "Pending",
            token,
          })
        ).unwrap(); // –ü–æ–ª—É—á–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∏–∑ createChat

        if (chat?.id) {
          await dispatch(
            sendMessage({
              chatId: chat.id,
              senderId: student.id,
              orderId: orderById.id,
              themeOrder: themeOrder,
              text: messageResponse,
              token,
            })
          ).unwrap();

          // –î–∞–µ–º —Ä–µ–Ω–¥–µ—Ä—É –æ—Ç—Ä–∞–±–æ—Ç–∞—Ç—å ‚Äî –∏ —Ç–æ–ª—å–∫–æ –ø–æ—Ç–æ–º –ø—É—à –∏ —Å–µ—Ç
          setTimeout(async () => {
            try {
              dispatch(getOrderById({ token, id: orderById?.id }));
              newChat(chat.id);
            } catch (error) {
              console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —á–∞—Ç–æ–≤:", error);
            }
          }, 0);
        }
      } catch (error) {
        console.error(
          "–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —á–∞—Ç–∞ –∏–ª–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è:",
          error
        );
      }
    }
    dispatch(setIsModalResponseStudentToTutor(false));
    dispatch(setScrollY(0));
    dispatch(setIsSheetOpen(false));
  };

  // –°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è —Å–≤–∏—Ç—á–∞
  const [isChecked, setIsChecked] = useState(true);

  const toggleSwitch = () => {
    setIsChecked((prev) => {
      const newState = !prev;
      return newState;
    });
  };

  return (
    <>
      <div className={styles.description}>
        –†–µ–ø–µ—Ç–∏—Ç–æ—Ä –ø–æ–ª—É—á–∏—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∏&nbsp;—Å–º–æ–∂–µ—Ç –æ—Ç–∫–ª–∏–∫–Ω—É—Ç—å—Å—è, –µ—Å–ª–∏
        –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –µ–≥–æ&nbsp;–∑–∞–∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç&nbsp;üì©
      </div>
      <div className={styles.inputContainer}>
        <textarea
          placeholder={"–õ—é–±–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞–∫–∞–∑–µ, –∫—Ä–æ–º–µ —Å—Å—ã–ª–æ–∫ –∏ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤"}
          autoComplete="off"
          value={inputValue}
          onChange={handleInputValue}
          onFocus={handleFocus}
          onBlur={handleBlur}
          className={clsx(styles.textarea, {
            [styles.focused]: isFocused,
            [styles.errorInput]: errorInput,
          })}
          maxLength={5000}
        />
      </div>

      <div
        className={clsx(
          stylesStudent.containerEntityShowEnd,
          styles.mrTp15,
          stylesStudent.containerEntityShowEndAlgnCntr
        )}
      >
        <div className={stylesStudent.containerEntityTitleDescription}>
          <div className={generalStyles.textBlc}>
            –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω —Ä–µ–ø–µ—Ç–∏—Ç–æ—Ä—É
          </div>
          <span className={clsx(generalStyles.textGr, generalStyles.text14)}>
            –†–µ–ø–µ—Ç–∏—Ç–æ—Ä –ø–æ–ª—É—á–∏—Ç –≤–∞—à –Ω–æ–º–µ—Ä –∏&nbsp;—Å–º–æ–∂–µ—Ç —Å–≤—è–∑–∞—Ç—å—Å—è —Å&nbsp;–≤–∞–º–∏
            –Ω–∞–ø—Ä—è–º—É—é&nbsp;‚òéÔ∏è
          </span>
        </div>
        <div className={stylesStudent.inputContainer}>
          <label className={stylesStudent.iosSwitch}>
            <input
              type="checkbox"
              checked={isChecked}
              onChange={toggleSwitch}
            />
            <span className={stylesStudent.slider}></span>
          </label>
        </div>
      </div>

      <div className={styles.button}>
        <button disabled={isLoading} onClick={update} type="button">
          –û—Ç–ø—Ä–∞–≤–∏—Ç—å
          {isLoading && (
            <div className={styles.buttonYlSpinner}>
              <Spinner />
            </div>
          )}
        </button>
      </div>
    </>
  );
};
